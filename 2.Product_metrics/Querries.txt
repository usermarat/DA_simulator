SELECT  start_date,
        day,
        source, 
        round(100 * end_count.user / start_count.user, 2) retention
FROM 
    (
    SELECT  start_date, 
            toDate(time) day,
            source,
            count(distinct user_id) user
    FROM simulator_20230620.feed_actions
    join 
        (
        SELECT user_id, min(toDate(time)) start_date
        from simulator_20230620.feed_actions 
        group by user_id
        ) t0
    using user_id 
    group by start_date, day, source
    having day = start_date + 10  
    ) end_count

join 

    (
    SELECT  start_date, 
            source,
            count(distinct user_id) user
    FROM simulator_20230620.feed_actions
    join 
        (
        SELECT user_id, min(toDate(time)) start_date
        from simulator_20230620.feed_actions 
        group by user_id
        ) t1
    using user_id 
    group by start_date, source
    ) start_count
using start_date, source


SELECT 
    start_week,
    week,
    source, 
    round(100 * end_count.user / start_count.user, 2) retention
FROM 
    (
    SELECT
        start_week,
        toMonday(toDate(time)) week,
        source,
        count(distinct user_id) user
    FROM simulator_20230620.feed_actions
    join 
        (
        SELECT 
            user_id,
            toMonday(min(toDate(time))) start_week
        from simulator_20230620.feed_actions 
        group by user_id
        ) t0
    using user_id 
    group by start_week, week, source
    having week = addWeeks(start_week, 1)
    ) end_count
join 
    (
    SELECT
        start_week, 
        source, 
        count(distinct user_id) user
    FROM simulator_20230620.feed_actions
    join 
        (
        SELECT user_id, toMonday(min(toDate(time))) start_week
        from simulator_20230620.feed_actions 
        group by user_id
        ) t1
    using user_id 
    group by start_week, source
    ) start_count
using start_week, source

SELECT user_id, source, toDate(time) date, start_date
FROM simulator_20230620.feed_actions
join 
(SELECT user_id, min(toDate(time)) start_date
from simulator_20230620.feed_actions 
group by user_id) t
using user_id 
where start_date = toDate('2023-06-13')


SELECT
    *,
    case 
        when user_id in 
                    (
                    SELECT user_id
                    FROM simulator_20230620.feed_actions
                    where toDate(time) = toDate('2023-06-21') or 
                    toDate(time) = toDate('2023-06-22')
                    group by user_id
                    having 
                    has(groupUniqArray(toDate(time)), toDate('2023-06-21')) = 1 AND 
                    has(groupUniqArray(toDate(time)), toDate('2023-06-22')) = 0
                    )
        then 1
        else 0
    end flag
FROM simulator_20230620.feed_actions


SELECT 
    this_week, 
    -uniq(user_id) as num_users, 
    status 
FROM
    (
    SELECT 
        user_id, 
        groupUniqArray(toMonday(toDate(time))) as weeks_visited, 
        addWeeks(arrayJoin(weeks_visited), +1) this_week, 
        if(has(weeks_visited, this_week) = 1, 'retained', 'gone') as status
    FROM simulator_20230620.feed_actions
    group by user_id
    )
where status = 'gone'
group by this_week, status
HAVING this_week != addWeeks(toMonday(today()), +1)

union all

SELECT 
    this_week, 
    uniq(user_id) as num_users, 
    status 
FROM
    (
    SELECT
        user_id, 
        groupUniqArray(toMonday(toDate(time))) as weeks_visited, 
        arrayJoin(weeks_visited) this_week, 
        if(has(weeks_visited, addWeeks(this_week, -1)) = 1, 'retained', 'new') as status
    FROM simulator_20230620.feed_actions
    group by user_id
    )
group by this_week, status 

SELECT 
    city,
    uniqIf(user_id, toDate(time) = toDate('2023-06-21')) day_0,
    uniqIf(user_id, toDate(time) = toDate('2023-06-22')) day_1,
    day_0 - day_1 delta
FROM simulator_20230620.feed_actions
where toDate(time) in (toDate('2023-06-21'), toDate('2023-06-22'))
and country = 'Russia'
group by city
order by delta desc